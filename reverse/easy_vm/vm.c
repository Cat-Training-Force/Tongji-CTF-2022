#include <inttypes.h>
#include <memory.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define VM_DATA_LEN 1024
typedef struct Vm{
    char *code;
    size_t code_len;
    size_t esp;
    size_t eip;
    uint32_t data[VM_DATA_LEN];
} Vm;
void push(Vm*vm,uint32_t data){
    vm->data[++(vm->esp)]=data;
}
uint32_t pop(Vm*vm){
    return vm->data[(vm->esp)--];
}
size_t vm_run(Vm*vm,uint32_t *data){
    size_t change=1;
    uint32_t a,b,d;
    switch(vm->code[vm->eip]){
        case 0: // exit
            change=(vm->code_len)-(vm->eip);
            break;
        case 1: // add
            push(vm,pop(vm)+pop(vm));
            break;
        case 2: // sub
            push(vm,pop(vm)-pop(vm));
            break;
        case 3: // xor
            push(vm,pop(vm)^pop(vm));
            break;
        case 4: // mul
            push(vm,pop(vm)*pop(vm));
            break;
        case 5:
            push(vm,data[*(uint32_t*)&(vm->code[vm->eip+1])]);
            change=5;
            break;
        case 6: // double
            d=pop(vm);
            push(vm,d);
            push(vm,d);
            break;
        case 7: // number
            push(vm,*(uint32_t*)&(vm->code[vm->eip+1]));
            change=5;
            break;
        case 8: // if
            a=pop(vm);
            b=pop(vm);
            if(a==b){
                push(vm,a);
            }else{
                push(vm,0xdead);
            }
            break;
    }
    return change;
}
void init_vm(Vm *vm,char *code,size_t code_len){
    vm->code=code;
    vm->code_len=code_len;
    vm->esp=-1;
    vm->eip=0;
    memset(vm->data,0,VM_DATA_LEN*sizeof(uint32_t));
}
int check(Vm*vm){
    if(vm->esp!=7)return 0;
    for(size_t i=0;i<=vm->esp;i++){
        if(vm->data[i]==0xdead)return 0;
    }
    return 1;
}
char code[]={7, 0, 0, 0, 0, 7, 177, 167, 0, 0, 5, 0, 0, 0, 0, 4, 1, 7, 20, 108, 179, 92, 3, 7, 154, 76, 0, 0, 5, 1, 0, 0, 0, 4, 1, 7, 63, 52, 0, 0, 5, 2, 0, 0, 0, 4, 1, 7, 243, 133, 0, 0, 5, 3, 0, 0, 0, 4, 1, 7, 175, 45, 0, 0, 5, 4, 0, 0, 0, 4, 1, 7, 119, 145, 0, 0, 5, 5, 0, 0, 0, 4, 1, 7, 49, 221, 0, 0, 5, 6, 0, 0, 0, 4, 1, 7, 152, 41, 0, 0, 5, 7, 0, 0, 0, 4, 1, 7, 186, 123, 75, 83, 8, 7, 0, 0, 0, 0, 7, 180, 2, 0, 0, 5, 0, 0, 0, 0, 4, 1, 7, 173, 100, 0, 0, 5, 1, 0, 0, 0, 4, 1, 7, 163, 244, 250, 219, 3, 7, 100, 86, 0, 0, 5, 2, 0, 0, 0, 4, 1, 7, 206, 17, 0, 0, 5, 3, 0, 0, 0, 4, 1, 7, 224, 152, 0, 0, 5, 4, 0, 0, 0, 4, 1, 7, 229, 78, 0, 0, 5, 5, 0, 0, 0, 4, 1, 7, 246, 210, 0, 0, 5, 6, 0, 0, 0, 4, 1, 7, 192, 152, 0, 0, 5, 7, 0, 0, 0, 4, 1, 7, 227, 133, 48, 216, 8, 7, 0, 0, 0, 0, 7, 115, 247, 0, 0, 5, 0, 0, 0, 0, 4, 1, 7, 143, 169, 0, 0, 5, 1, 0, 0, 0, 4, 1, 7, 217, 141, 0, 0, 5, 2, 0, 0, 0, 4, 1, 7, 26, 58, 189, 245, 3, 7, 135, 58, 0, 0, 5, 3, 0, 0, 0, 4, 1, 7, 42, 193, 0, 0, 5, 4, 0, 0, 0, 4, 1, 7, 155, 181, 0, 0, 5, 5, 0, 0, 0, 4, 1, 7, 84, 44, 0, 0, 5, 6, 0, 0, 0, 4, 1, 7, 52, 240, 0, 0, 5, 7, 0, 0, 0, 4, 1, 7, 211, 193, 213, 16, 8, 7, 0, 0, 0, 0, 7, 58, 7, 0, 0, 5, 0, 0, 0, 0, 4, 1, 7, 201, 248, 0, 0, 5, 1, 0, 0, 0, 4, 1, 7, 123, 74, 0, 0, 5, 2, 0, 0, 0, 4, 1, 7, 62, 98, 0, 0, 5, 3, 0, 0, 0, 4, 1, 7, 54, 110, 207, 122, 3, 7, 255, 156, 0, 0, 5, 4, 0, 0, 0, 4, 1, 7, 252, 95, 0, 0, 5, 5, 0, 0, 0, 4, 1, 7, 93, 38, 0, 0, 5, 6, 0, 0, 0, 4, 1, 7, 255, 146, 0, 0, 5, 7, 0, 0, 0, 4, 1, 7, 212, 23, 13, 97, 8, 7, 0, 0, 0, 0, 7, 230, 152, 0, 0, 5, 0, 0, 0, 0, 4, 1, 7, 64, 182, 0, 0, 5, 1, 0, 0, 0, 4, 1, 7, 196, 236, 0, 0, 5, 2, 0, 0, 0, 4, 1, 7, 40, 62, 0, 0, 5, 3, 0, 0, 0, 4, 1, 7, 194, 165, 0, 0, 5, 4, 0, 0, 0, 4, 1, 7, 1, 146, 71, 205, 3, 7, 138, 238, 0, 0, 5, 5, 0, 0, 0, 4, 1, 7, 202, 104, 0, 0, 5, 6, 0, 0, 0, 4, 1, 7, 131, 155, 0, 0, 5, 7, 0, 0, 0, 4, 1, 7, 193, 126, 212, 125, 8, 7, 0, 0, 0, 0, 7, 197, 8, 0, 0, 5, 0, 0, 0, 0, 4, 1, 7, 108, 128, 0, 0, 5, 1, 0, 0, 0, 4, 1, 7, 233, 114, 0, 0, 5, 2, 0, 0, 0, 4, 1, 7, 158, 74, 0, 0, 5, 3, 0, 0, 0, 4, 1, 7, 129, 151, 0, 0, 5, 4, 0, 0, 0, 4, 1, 7, 176, 183, 0, 0, 5, 5, 0, 0, 0, 4, 1, 7, 185, 230, 139, 1, 3, 7, 140, 213, 0, 0, 5, 6, 0, 0, 0, 4, 1, 7, 71, 66, 0, 0, 5, 7, 0, 0, 0, 4, 1, 7, 201, 38, 138, 28, 8, 7, 0, 0, 0, 0, 7, 198, 224, 0, 0, 5, 0, 0, 0, 0, 4, 1, 7, 97, 52, 0, 0, 5, 1, 0, 0, 0, 4, 1, 7, 169, 46, 0, 0, 5, 2, 0, 0, 0, 4, 1, 7, 125, 245, 0, 0, 5, 3, 0, 0, 0, 4, 1, 7, 44, 83, 0, 0, 5, 4, 0, 0, 0, 4, 1, 7, 150, 76, 0, 0, 5, 5, 0, 0, 0, 4, 1, 7, 162, 250, 0, 0, 5, 6, 0, 0, 0, 4, 1, 7, 111, 124, 46, 37, 3, 7, 106, 118, 0, 0, 5, 7, 0, 0, 0, 4, 1, 7, 173, 109, 141, 162, 8, 7, 0, 0, 0, 0, 7, 23, 43, 0, 0, 5, 0, 0, 0, 0, 4, 1, 7, 217, 201, 0, 0, 5, 1, 0, 0, 0, 4, 1, 7, 129, 165, 0, 0, 5, 2, 0, 0, 0, 4, 1, 7, 53, 153, 0, 0, 5, 3, 0, 0, 0, 4, 1, 7, 89, 238, 0, 0, 5, 4, 0, 0, 0, 4, 1, 7, 246, 131, 0, 0, 5, 5, 0, 0, 0, 4, 1, 7, 79, 229, 0, 0, 5, 6, 0, 0, 0, 4, 1, 7, 127, 252, 0, 0, 5, 7, 0, 0, 0, 4, 1, 7, 50, 121, 166, 225, 3, 7, 104, 145, 170, 4, 8, 0};
int main(){
    Vm vm;
    init_vm(&vm,code,sizeof(code));
    size_t cnt=0;
    puts("Please input:");
    char f[256];
    scanf("%s",f);
    size_t len=strlen(f);
    uint32_t *s=(uint32_t*)f;
    while(vm.eip<sizeof(code)){
        size_t change=vm_run(&vm,s);
        vm.eip+=change;
    }
    if(check(&vm)){
        printf("Your flag: tjctf{%s}\n",f);
    }else{
        puts("Wrong!!!");
    }
}